name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  changed-files:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.changes.outputs.matrix }}
      any_changed: ${{ steps.changes.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changes
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | grep "^dotfiles/" || true)
          
          if [[ -z "$CHANGED_FILES" ]]; then
            echo "any_changed=false" >> $GITHUB_OUTPUT
            echo "matrix={\"tool\":[]}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "any_changed=true" >> $GITHUB_OUTPUT
          
          # Extract unique tool names
          TOOLS=$(echo "$CHANGED_FILES" | cut -d'/' -f2 | sort -u | jq -R . | jq -s -c '{tool: .}')
          echo "matrix=$TOOLS" >> $GITHUB_OUTPUT
          
          # Log for debugging
          echo "Changed tools: $TOOLS"

  validate-changed-tools:
    name: Validate ${{ matrix.tool }}
    needs: changed-files
    if: needs.changed-files.outputs.any_changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.changed-files.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up validation environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq lua5.4 shellcheck stow make
          pip3 install toml pyyaml
      
      - name: Validate ${{ matrix.tool }} configuration
        run: |
          echo "Validating ${{ matrix.tool }}..."
          TOOL_DIR="dotfiles/${{ matrix.tool }}"
          
          # Check for JSON files
          find "$TOOL_DIR" -name "*.json" -type f | while read -r file; do
            echo "Validating JSON: $file"
            jq empty "$file" || exit 1
          done
          
          # Check for YAML files
          find "$TOOL_DIR" -name "*.yaml" -o -name "*.yml" -type f | while read -r file; do
            echo "Validating YAML: $file"
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done
          
          # Check for TOML files
          find "$TOOL_DIR" -name "*.toml" -type f | while read -r file; do
            echo "Validating TOML: $file"
            python3 -c "import toml; toml.load('$file')" || exit 1
          done
          
          # Check for Lua files
          find "$TOOL_DIR" -name "*.lua" -type f | while read -r file; do
            echo "Validating Lua: $file"
            lua -l "$file" -e "" 2>/dev/null || luac -p "$file" || exit 1
          done
      
      - name: Test ${{ matrix.tool }} installation
        run: |
          TEST_HOME="/tmp/test-home-$$"
          mkdir -p "$TEST_HOME"
          HOME="$TEST_HOME" make stow-${{ matrix.tool }} || exit 1
          
          # Verify symlinks were created
          if [[ -d "dotfiles/${{ matrix.tool }}/.config" ]]; then
            ls -la "$TEST_HOME/.config/" || true
          fi
          
          # Cleanup
          HOME="$TEST_HOME" make unstow-${{ matrix.tool }} || true
          rm -rf "$TEST_HOME"

  pr-comment:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [changed-files, validate-changed-tools]
    if: always() && needs.changed-files.outputs.any_changed == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const tools = ${{ needs.changed-files.outputs.matrix }}.tool;
            const validation = '${{ needs.validate-changed-tools.result }}';
            
            let body = '## ðŸ” PR Validation Results\n\n';
            
            if (validation === 'success') {
              body += 'âœ… All validations passed!\n\n';
            } else if (validation === 'failure') {
              body += 'âŒ Some validations failed. Please check the logs.\n\n';
            } else {
              body += 'âš ï¸ Validation was skipped or cancelled.\n\n';
            }
            
            if (tools.length > 0) {
              body += '### Changed Tools:\n';
              tools.forEach(tool => {
                body += `- \`${tool}\`\n`;
              });
            }
            
            body += '\n### Checks Performed:\n';
            body += '- âœ“ Configuration syntax validation\n';
            body += '- âœ“ Installation test\n';
            body += '- âœ“ Symlink verification\n';
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Validation Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }